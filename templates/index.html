<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Suma simple con Flask</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="scroll-x">
        <!-- Columna 1: Formulario SIEMPRE visible -->
        <div class="columna">
            <h1 class="proyec-title">Datos Generales</h1>
            <form method="post" class="proyec-form">
                <div class="form-group">
                    <label for="nombre_proyecto">Nombre del proyecto:</label>
                    <input type="text" name="nombre_proyecto" id="nombre_proyecto" value="{{ datos.nombre_proyecto }}">
                </div>                
                <div class="form-group">
                    <label for="nombre_colegio">Nombre del colegio:</label>
                    <input type="text" name="nombre_colegio" id="nombre_colegio" value="{{ datos.nombre_colegio }}">
                </div>                    
                <div class="form-group">
                    <label for="nivel">Nivel:</label>
                    <select name="nivel" id="nivel">
                        <option value="Primaria" {% if datos.nivel == 'Primaria' %}selected{% endif %}>Primaria</option>
                        <option value="Secundaria" {% if datos.nivel == 'Secundaria' %}selected{% endif %}>Secundaria</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="radio_influencia">Radio de influencia (KM, 1.5 Primaria, 3.0 Secundaria):</label>
                    <input type="number" name="radio_influencia" id="radio_influencia" required value="{{ datos.radio_influencia }}">
                </div>
                <div class="form-group">
                    <label for="area_distrito">Área del distrito (KM²):</label>
                    <input type="number" name="area_distrito" id="area_distrito" required value="{{ datos.area_distrito }}">
                </div>
                <div class="form-group">
                    <label for="anio_form">Año de formulación:</label>
                    <input type="number" name="anio_form" id="anio_form" required value="{{ datos.anio_form }}">
                </div>                    
                <div class="form-group">
                    <label for="cantidad_anios_matricula">Años de matrícula disponibles (años atrás):</label>
                    <input type="number" name="cantidad_anios_matricula" id="cantidad_anios_matricula" required value="{{ datos.cantidad_anios_matricula }}">
                </div>
                <div class="form-group">
                    <label for="anio_i">Inicio de funcionamiento (año):</label>
                    <input type="number" name="anio_i" id="anio_i" required value="{{ datos.anio_i }}">
                </div>
                <div class="form-group">
                    <label for="anio_f">Fin de funcionamiento (año):</label>
                    <input type="number" name="anio_f" id="anio_f" required value="{{ datos.anio_f }}">
                </div>           
                <div class="form-group">
                    <label for="censo_1">Año del primer censo:</label>
                    <input type="number" name="censo_1" id="censo_1" required value="{{ datos.censo_1 }}">
                </div>           
                <div class="form-group">
                    <label for="censo_2">Año del segundo censo:</label>
                    <input type="number" name="censo_2" id="censo_2" required value="{{ datos.censo_2 }}">
                </div>                                                    
                <div class="form-group">
                    <label for="tipo">Tipo de proyección:</label>
                    <select name="tipo" id="tipo">
                        <option value="Geométrica - Recomendado" {% if datos.tipo == 'Geométrica - Recomendado' %}selected{% endif %}>Geométrica - Recomendado</option>
                    </select>
                </div>     
                <div class="form-row">
                    <button type="submit" class="proyec-btn">Guardar</button>
                </div>
            </form>
            {% if error %}
                <div class="proyec-error">{{ error }}</div>
            {% endif %}
        </div>
        <div class="columna">
            <h3 class="proyec-title">Población, matrícula y no promovidos</h3>            
                {% if paso >= 2 %}            
                <form method="post" class="proyec-form">
                    <div class="form-group">
                        <label for="pob_tot_censo1">Población total del distrito en el año {{ censo_1 }}:</label>
                        <input type="number" name="pob_tot_censo1" id="pob_tot_censo1" required value="{{ pob_tot_censo1 }}">
                    </div>
                    <div class="form-group">
                        <label for="pob_tot_censo2">Población total del distrito en el año {{ censo_2 }}:</label>
                        <input type="number" name="pob_tot_censo2" id="pob_tot_censo2" required value="{{ pob_tot_censo2 }}">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Edad</th>
                                <th>{{ censo_1 }}</th>
                                <th>{{ censo_2 }}</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% if nivel == 'Primaria' %}
                            {% for edad in range(6, 12) %}
                                <tr>
                                    <td>{{ edad }}</td>
                                    <td><input type="number" name="pob_tot_edad_censo1_{{ edad }}" value="{{ pob_tot_edad_censo1_[edad]}}"></td>
                                    <td><input type="number" name="pob_tot_edad_censo2_{{ edad }}" value="{{ pob_tot_edad_censo2_[edad]}}"></td>
                                </tr>
                            {% endfor %}
                        {% elif nivel == 'Secundaria' %}
                            {% for edad in range(12, 17) %}
                                <tr>
                                    <td>{{ edad }}</td>
                                    <td><input type="number" name="pob_tot_edad_censo1_{{ edad }}" value="{{ pob_tot_edad_censo1_[edad]}}"></td>
                                    <td><input type="number" name="pob_tot_edad_censo2_{{ edad }}" value="{{ pob_tot_edad_censo2_[edad]}}"></td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                        </tbody>
                    </table>
                    <table>
                        <thead>
                            <tr>
                                <th>Edad</th>
                                {% for a in anios_hist %}
                                    <th>{{ a }}</th>
                                {% endfor %}
                            </tr>
                        </thead>            
                        <tbody>
                        {% if nivel == 'Primaria' %}
                            {% for edad in range(6, 12) %}
                                <tr>
                                    <td>{{ edad }}</td>
                                    {% for a in anios_hist %}
                                        <td><input type="number" name="matricula_{{ edad }}_{{ a }}" value="{{ matricula_[edad][a] }}" style="width: 90px;"></td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        {% elif nivel == 'Secundaria' %}
                            {% for edad in range(12, 17) %}
                                <tr>
                                    <td>{{ edad }}</td>
                                    {% for a in anios_hist %}
                                        <td><input type="number" name="matricula_{{ edad }}_{{ a }}" value="{{ matricula_[edad][a] }}" style="width: 90px;"></td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        {% endif %} 
                    </table>
                    <table>
                        <thead>
                            <tr>
                                <th>Edad</th>
                                {% for a in anios_hist %}
                                    <th>{{ a }}</th>
                                {% endfor %}
                            </tr>
                        </thead>            
                        <tbody>
                        {% if nivel == 'Primaria' %}
                            {% for edad in range(6, 12) %}
                                <tr>
                                    <td>{{ edad }}</td>
                                    {% for a in anios_hist %}
                                        <td><input type="number" name="noprom_{{ edad }}_{{ a }}" value="{{ noprom_[edad][a] }}" style="width: 90px;"></td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        {% elif nivel == 'Secundaria' %}
                            {% for edad in range(12, 17) %}
                                <tr>
                                    <td>{{ edad }}</td>
                                    {% for a in anios_hist %}
                                        <td><input type="number" name="noprom_{{ edad }}_{{ a }}" value="{{ noprom_[edad][a] }}" style="width: 90px;"></td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        {% endif %} 
                    </table>                
                    <div class="form-row">
                        <button type="submit" class="proyec-btn">Guardar2</button>
                    </div>                
                </form>
                    {% if error %}
                        <div class="proyec-error">{{ error }}</div>
                    {% endif %}                            
            {% endif %}
        </div>        

        <div class="columna">
            {% if paso == 3 %}
                <h3 class="proyec-title">Población total</h3>
                <!-- Canvas para el gráfico de barras -->
                <canvas id="graficoPoblacion" width="600" height="300"></canvas>
                <script>
                    // Recibe los datos de Flask y los convierte a arrays de JS
                    var anios = {{ anio_proy|tojson|safe }};
                    var poblacion = {{ pop_tot_proyec|tojson|safe }};

                    // Solo dibuja el gráfico si hay datos
                    if (anios && poblacion && anios.length > 0 && poblacion.length > 0) {
                        var ctx = document.getElementById('graficoPoblacion').getContext('2d');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: anios,
                                datasets: [{
                                    label: 'Población proyectada',
                                    data: poblacion,
                                    backgroundColor: 'rgba(185, 28, 28, 0.5)',
                                    borderColor: 'rgba(185, 28, 28, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Población'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Año'
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        console.log('No hay datos para graficar');
                    }
                </script>
            {% endif %}
        </div>
    </div>
</body>
</html>